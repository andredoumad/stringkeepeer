{% extends 'base.html' %}


{% block content %}
<!-- 
<button>Click Here to Toggle</button>

<div class="textLine" style="background-color:yellow;">
 This is a yellow line.....
</div> -->


{% if payment_company == 'stripe' %}
<!-- _Stripe_ Form START -->
<div class='col-10 col-md-6 mx-auto'>
    <h1>Add Payment Method</h1>
    <div class='stripe-payment-form' data-token='{{ publish_key }}' data-next-url='{% if next_url %}{{ next_url }}{% endif %}' data-btn-title='Add New Card'></div>
</div>
<!-- _Stripe_ Form END -->
{% endif %}

======= DEBUG ==========

<hr/>
braintree_payment_method_token: {{ braintree_payment_method_token }}

<hr/>
gordon: {{ gordon }}
<hr/>
testvariable: {{ testvariable }}
<hr/>
nonce: {{ nonce }}
<hr/>
user_first_name: {{ user_first_name }}
<hr/>
user_last_name: {{ user_last_name }}
<hr/>
user_email: {{ user_email }}
<hr/>
billing_profile: {{ billing_profile }}
<hr/>
billing_profile_created: {{ billing_profile_created }}
<hr/>
billing_profile_first_name: {{ billing_profile_first_name }}
<hr/>
billing_profile_last_name: {{ billing_profile_last_name }}
<hr/>
billing_profile_street: {{ billing_profile_street }}
<hr/>
billing_profile_postal_code: {{ billing_profile_postal_code }}
<hr/>
braintree_customer_id: {{ braintree_customer_id }}
<hr/>
collection: {{ collection }}
<hr/>
braintree_customer_first_name: {{ braintree_customer_first_name }}
<hr/>
braintree_customer_last_name: {{ braintree_customer_last_name }}
<hr/>
braintree_customer_email: {{ braintree_customer_email }}
<hr/>
cart: {{ cart }}
<hr/>
cart_created: {{ cart_created }}
<hr/>
order_profile: {{ order_profile }}
<hr/>
order_profile_created: {{ order_profile_created }}
<hr/>
order_billing_address: {{ order_billing_address }}
<hr/>
client token: {{ client_token }}
<hr/>
======= DEBUG ==========
<hr/>

{% if payment_company != 'stripe' %}

<meta charset="utf-8">

<!-- includes the Braintree JS client SDK -->
<script src="https://js.braintreegateway.com/web/dropin/1.21.0/js/dropin.min.js"></script>

<!-- includes jQuery -->
<script src="http://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>

<form action="." method="POST" id="payment-form" name="payment-form">
  {% csrf_token %}

  {{ paymentform.as_p }}

  <!-- <div id="checkoutMethods"> -->
    <div style="margin: 10px;">
      <div id="dropin-container"></div>
      <input type="hidden" id="nonce" name="nonce" />
      <input type="hidden" id="testvariable" name="testvariable" />
      <input type="hidden" id="gordon" name="gordon" />
    </div>
  <!-- </div> -->
  <button id="submit-button">Save</button>
</form>
<script>
  var button = document.querySelector('#submit-button');
  var form = document.querySelector('#payment-form');
  var testvariable = 'emptytestvariable';
  var nonce = 'emptynonce';
  var gordon = 'emptygordon';
  var payload_nonce;

  braintree.dropin.create({
    authorization: '{{ client_token }}',
    container: '#dropin-container'
  }, function (createErr, instance) {
    button.addEventListener('click', function () {
      document.querySelector('#testvariable').value = 'hello from javascript'
      console.log("document.querySelector('#testvariable').value: " + document.querySelector('#testvariable').value)
      document.querySelector('#gordon').value = 'hello gordon from javascript'
      console.log("document.querySelector('#gordon').value: " + document.querySelector('#gordon').value)

      function updateGordon(gordon_update_value){ 
          console.log('updateGordon function: ' + gordon_update_value)
          document.querySelector('#gordon').value = gordon_update_value
          console.log("document.querySelector('#gordon').value: " + document.querySelector('#gordon').value)
          document.querySelector('#testvariable').value = 'hello from updategordon'
          document.querySelector('#gordon').value = 'hello gordon freeman'
      }
      instance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
        // When the user clicks on the 'Submit payment' button this code will send the
        // encrypted payment information in a variable called a payment method nonce

        document.querySelector('#nonce').value = payload.nonce
        console.log('payment method nonce is: ' + payload.nonce)
        $('#nonce').val(payload.nonce);
        $('#gordon').val(payload.nonce);
        gordon = payload.nonce
        
        updateGordon(payload.nonce)
        // console.log('gordon is: ' + gordon)
        // document.querySelector('#gordon').value = payload.nonce
        nonce = payload.nonce
        console.log('nonce A: ' + document.querySelector('#nonce').value)
        
        console.log('HELLO')
        $.ajax({
          type: 'POST',
          url: '/cart/checkout/success/',
          data: {'paymentMethodNonce': payload.nonce}
        }).done(function(result) {
          console.log('nonce B: ' + document.querySelector('#nonce').value)
          // Tear down the Drop-in UI
          instance.teardown(function (teardownErr) {
            console.log('nonce C: ' + document.querySelector('#nonce').value)

            if (teardownErr) {
              console.error('Could not tear down Drop-in UI!');
            } else {
              console.log('nonce D: ' + document.querySelector('#nonce').value)
              console.info('Drop-in UI has been torn down!');
              // Remove the 'Submit payment' button
              $('#submit-button').remove();
            }
          });
          console.log('nonce E: ' + document.querySelector('#nonce').value)
          if (result.success) {
            console.log('nonce F: ' + document.querySelector('#nonce').value)
            $('#nonce').value(nonce)
            $('#checkout-message').html('<h1>Success</h1><p>Your Drop-in UI is working! Check your <a href="https://sandbox.braintreegateway.com/login">sandbox Control Panel</a> for your test transactions.</p><p>Refresh to try another transaction.</p>');
          } else {
            console.log(result);
            $('#checkout-message').html('<h1>Error</h1><p>Check your console.</p>');
          }
          console.log('nonce G: ' + document.querySelector('#nonce').value)
          gordon = document.querySelector('#nonce').value
          console.log('gordon final: ' + gordon)
          payload_nonce = gordon
          console.log('payload_nonce A: ' + payload_nonce)
          document.querySelector('#testvariable').value = payload_nonce
          form.submit()
        })
      })
    })
  })
</script>


<!-- 
<div id="dropin-wrapper">
  <div id="checkout-message"></div>
  <div id="dropin-container"></div>
  <button id="submit-button">Submit payment</button>
</div>
<script>
  var button = document.querySelector('#submit-button');

  braintree.dropin.create({
    // Insert your tokenization key here
    authorization: '{{ client_token }}',
    container: '#dropin-container'
  }, function (createErr, instance) {
    button.addEventListener('click', function () {
      instance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
        // When the user clicks on the 'Submit payment' button this code will send the
        // encrypted payment information in a variable called a payment method nonce
        console.log('HELLO')
        $.ajax({
          type: 'POST',
          url: '/cart/checkout/success/',
          data: {'paymentMethodNonce': payload.nonce}
        }).done(function(result) {
          // Tear down the Drop-in UI
          instance.teardown(function (teardownErr) {
            if (teardownErr) {
              console.error('Could not tear down Drop-in UI!');
            } else {
              console.info('Drop-in UI has been torn down!');
              // Remove the 'Submit payment' button
              $('#submit-button').remove();
            }
          });

          if (result.success) {
            $('#checkout-message').html('<h1>Success</h1><p>Your Drop-in UI is working! Check your <a href="https://sandbox.braintreegateway.com/login">sandbox Control Panel</a> for your test transactions.</p><p>Refresh to try another transaction.</p>');
          } else {
            console.log(result);
            $('#checkout-message').html('<h1>Error</h1><p>Check your console.</p>');
          }
        });
        
      });
    });
  });
</script> -->
{% endif %}

{% endblock %}
