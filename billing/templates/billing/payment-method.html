{% extends 'base.html' %}


{% block content %}


<meta charset="utf-8">

<!-- includes the Braintree JS client SDK -->
<script src="https://js.braintreegateway.com/web/dropin/1.21.0/js/dropin.min.js"></script>

<!-- includes jQuery -->
<!-- <script src="http://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script> -->
<script
src="https://code.jquery.com/jquery-3.4.1.slim.js"
integrity="sha256-BTlTdQO9/fascB1drekrDVkaKd9PkwBymMlHOiG+qLI="
crossorigin="anonymous"></script>


  <!-- Load the required client component. -->
  <script src="https://js.braintreegateway.com/web/3.57.0/js/client.min.js"></script>

  <!-- Load Hosted Fields component. -->
  <script src="https://js.braintreegateway.com/web/3.57.0/js/hosted-fields.min.js"></script>


<div class="card bg-light my-3"">
<form action="." method="POST" id="payment-form" name="payment-form">
  {% csrf_token %}
    <div style="margin: 40px;">
      <div id="dropin-container"></div>
      <input type="hidden" id="remove-subscription-field-id" name="remove-subscription-field-name" />
      <input type="hidden" id="nonce" name="nonce" />
      <input type="hidden" id="testvariable" name="testvariable" />
      <input type="hidden" id="gordon" name="gordon" />
    </div>
</div>  
  <div class="card bg-dark my-3"">
    <button type='button' id="submit-button" class='btn btn-info btn-lg btn-block'>Save</button>
  </div>
</form> 


<!-- BRAINTREE DROPIN -->
<script>

  var button = document.querySelector('#submit-button');
  var form = document.querySelector('#payment-form');
  var testvariable = 'emptytestvariable';
  var nonce = 'emptynonce';
  var gordon = 'emptygordon';
  var payload_nonce;

  braintree.dropin.create({

    authorization: '{{ client_token }}',
    container: '#dropin-container',
    card: {
    cardholderName: { required: true },
    overrides: {
      styles: {

        input: {
          color: 'blue',
          'font-size': '18px'
        },
        '.number': {
          'font-family': 'monospace'
          // Custom web fonts are not supported. Only use system installed fonts.
        },
        '.invalid': {
          color: 'red'
        }
      }
    }
  }
}, function (createErr, instance) {
    button.addEventListener('click', function () {
      document.querySelector('#testvariable').value = 'hello from javascript'
      console.log("document.querySelector('#testvariable').value: " + document.querySelector('#testvariable').value)
      document.querySelector('#gordon').value = 'hello gordon from javascript'
      console.log("document.querySelector('#gordon').value: " + document.querySelector('#gordon').value)

      function updateGordon(gordon_update_value){ 
          console.log('updateGordon function: ' + gordon_update_value)
          document.querySelector('#gordon').value = gordon_update_value
          console.log("document.querySelector('#gordon').value: " + document.querySelector('#gordon').value)
          document.querySelector('#testvariable').value = 'hello from updategordon'
          document.querySelector('#gordon').value = 'hello gordon freeman'
      }
      instance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
        // When the user clicks on the 'Submit payment' button this code will send the
        // encrypted payment information in a variable called a payment method nonce

        document.querySelector('#nonce').value = payload.nonce
        console.log('payment method nonce is: ' + payload.nonce)
        $('#nonce').val(payload.nonce);
        $('#gordon').val(payload.nonce);
        gordon = payload.nonce
        
        updateGordon(payload.nonce)
        // console.log('gordon is: ' + gordon)
        // document.querySelector('#gordon').value = payload.nonce
        nonce = payload.nonce
        console.log('nonce A: ' + document.querySelector('#nonce').value)
        
        console.log('HELLO')
        $.ajax({
          type: 'POST',
          url: '/cart/checkout/success/',
          data: {'paymentMethodNonce': payload.nonce}
        }).done(function(result) {
          console.log('nonce B: ' + document.querySelector('#nonce').value)
          // Tear down the Drop-in UI
          instance.teardown(function (teardownErr) {
            console.log('nonce C: ' + document.querySelector('#nonce').value)

            if (teardownErr) {
              console.error('Could not tear down Drop-in UI!');
            } else {
              console.log('nonce D: ' + document.querySelector('#nonce').value)
              console.info('Drop-in UI has been torn down!');
              // Remove the 'Submit payment' button
              $('#submit-button').remove();
            }
          });
          console.log('nonce E: ' + document.querySelector('#nonce').value)
          if (result.success) {
            console.log('nonce F: ' + document.querySelector('#nonce').value)
            $('#nonce').value(nonce)
            $('#checkout-message').html('<h1>Success</h1><p>Your Drop-in UI is working! Check your <a href="https://sandbox.braintreegateway.com/login">sandbox Control Panel</a> for your test transactions.</p><p>Refresh to try another transaction.</p>');
          } else {
            console.log(result);
            $('#checkout-message').html('<h1>Error</h1><p>Check your console.</p>');
          }
          console.log('nonce G: ' + document.querySelector('#nonce').value)
          gordon = document.querySelector('#nonce').value
          console.log('gordon final: ' + gordon)
          payload_nonce = gordon
          console.log('payload_nonce A: ' + payload_nonce)
          document.querySelector('#testvariable').value = payload_nonce

          console.log("document.querySelector('#remove-subscription-field-id').value: " + document.querySelector('#remove-subscription-field-id'))
          console.log("document.querySelector('#remove-subscription-field-name').value: " + document.querySelector('#remove-subscription-field-name'))
          form.submit()
        })

      })
    })
  })
</script>


<hr/>

<!-- Active Subscriptions -->
<!-- <div class="card bg-dark text-white my-6 text-center">
  <div class="card-body">
    <h4 class="card-title">ACTIIVE SUBSCRIPTIONS</h4>
</div>
</div> -->

{% for subscription in customer_active_subscriptions %}
<hr/>
<div class="card bg-secondary text-white mx-2 my-2">
  
  <div class="card bg-dark text-white text-center mx-2 my-2" >
    <div class="card bg-dark text-white text-center mx-2 my-2" >
    Subscription: {{ subscription.plan_id }} 
    </div>
    <div class="card bg-dark text-white text-center mx-2 my-2" >
    Status: {{ subscription.status }} 
    </div>
    <div class="card bg-dark text-white text-center mx-2 my-2" >
    Billing Date: {{ subscription.next_billing_date }} 
    </div>
    <div class="card bg-dark text-white text-center mx-2 my-2" >
    Billing Amount: {{ subscription.next_bill_amount }} 
    </div>
    <div class="card bg-dark text-white text-center mx-2 my-2" >
    <a class='btn btn-link mx-2 btn-sm' onclick="RemoveSubscription('{{ subscription.id }}')" href="#"> cancel </a>
    </div>
  </div>
  <input type="hidden" id="{{ subscription.id }}" name="{{ subscription.id }}" value='{{ subscription.id }}' />
</div>
<hr/>
{% endfor %}

<script>
  function RemoveSubscription(subscription) {
    console.log('RemoveSubscription')
      $.ajax({
          url : '.',
          type : "POST",
          data : { removeSubscription : subscription }
      }).done(function(returned_data){
        console.log('returned_data: ' + JSON.stringify(returned_data))
          // This is the ajax.done() method, where you can fire events after the ajax method is complete 
  
          // For instance, you could hide/display your add/remove button here
  
      });
  }
</script>



{% endblock %}




======= DEBUG ==========
<hr/>
braintree_payment_method_token: {{ braintree_payment_method_token }}
<hr/>
gordon: {{ gordon }}
<hr/>
testvariable: {{ testvariable }}
<hr/>
nonce: {{ nonce }}
<hr/>
user_first_name: {{ user_first_name }}
<hr/>
user_last_name: {{ user_last_name }}
<hr/>
user_email: {{ user_email }}
<hr/>
billing_profile: {{ billing_profile }}
<hr/>
billing_profile_created: {{ billing_profile_created }}
<hr/>
billing_profile_first_name: {{ billing_profile_first_name }}
<hr/>
billing_profile_last_name: {{ billing_profile_last_name }}
<hr/>
billing_profile_street: {{ billing_profile_street }}
<hr/>
billing_profile_postal_code: {{ billing_profile_postal_code }}
<hr/>
braintree_customer_id: {{ braintree_customer_id }}
<hr/>
braintree_customer_first_name: {{ braintree_customer_first_name }}
<hr/>
braintree_customer_last_name: {{ braintree_customer_last_name }}
<hr/>
braintree_customer_email: {{ braintree_customer_email }}
<hr/>
cart: {{ cart }}
<hr/>
cart_created: {{ cart_created }}
<hr/>
order_profile: {{ order_profile }}
<hr/>
order_profile_created: {{ order_profile_created }}
<hr/>
order_billing_address: {{ order_billing_address }}
<hr/>
client token: {{ client_token }}
<hr/>
======= DEBUG ==========
<hr/>